<?php

/**
 * @file
 * Miscellaneous hook implementations.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_islandora_solr_query().
 *
 * Adds a collection as a filter if it is defined in the url params.
 */
function islandora_collection_search_islandora_solr_query($islandora_solr_query) {
  $query = \Drupal::request()->query;
  // Exit early if the collection PID isn't set in the URL params.
  if (!$query->has('cp')) {
    return;
  }

  // Grab the collection pid and add it as a Solr query filter.
  $collection_pid = $query->get('cp');
  $ancestor_field = \Drupal::config('islandora_collection_search.settings')->get('islandora_collection_search_ancestor_field');
  $filter = strtr('!field:"!value"', [
    '!field' => $ancestor_field,
    '!value' => $collection_pid,
  ]);
  $islandora_solr_query->solrParams['fq'][] = $filter;
}

/**
 * Implements hook_form_alter().
 *
 * Adds a submit handler to any form that can potentially alter the object
 * hierarchy (e.g. changing parents, etc...).
 */
function islandora_collection_search_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  switch ($form_id) {
    case 'islandora_basic_collection_migrate_children_form':
    case 'islandora_basic_collection_share_children_form':
    case 'islandora_basic_collection_delete_children_form':
      $form['#submit'][] = 'islandora_collection_search_collection_form_submit';
      break;
  }
}

/**
 * Re-indexes all children of the object(s) manipulated by a form.
 *
 * @param array $form
 *   Array of drupal form api elements.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   Array representing the form state.
 */
function islandora_collection_search_collection_form_submit(array $form, FormStateInterface $form_state) {
  // Grab the initial list of children that are being migrated from the form.
  $children = array_keys(array_filter($form_state->getValue('children')));
  module_load_include('inc', 'islandora_collection_search', 'includes/batch');
  batch_set(islandora_collection_search_reindex_descendants_batch($children));
}

/**
 * Implements hook_form_FORMID_alter().
 */
function islandora_collection_search_form_islandora_solr_advanced_search_form_alter(array &$form, FormStateInterface $form_state) {
  if (\Drupal::config('islandora_collection_search.settings')->get('islandora_collection_search_advanced_search_alter')) {
    module_load_include('inc', 'islandora_collection_search', 'includes/utilities');
    $default_options = [
      'all' => t('All collections'),
    ];
    $collections = islandora_collection_search_retrieve_searchable_collections($default_options, FALSE);
    $form['collections'] = [
      '#type' => 'select',
      '#options' => $collections,
      '#weight' => 5,
    ];
    $form['controls']['#weight'] = 6;
    $form['#submit'][] = 'islandora_collection_search_append_collection_pid';
  }
}

/**
 * Submit handler which appends the collection PID to the query.
 *
 * @param array $form
 *   An array representing a form within Drupal.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   An array representing the Drupal form state.
 */
function islandora_collection_search_append_collection_pid(array $form, FormStateInterface $form_state) {
  if ($form_state->getValue('collections') != 'all') {
    $redirect = $form_state->getRedirect();
    $options = $redirect->getOptions();
    $options['query']['cp'] = $form_state->getValue('collections');
    $redirect->setOptions($options);
  }
}
